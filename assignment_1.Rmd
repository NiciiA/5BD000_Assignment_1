---
title: "5BD000 Assignment 1"
author: "Nicolas Ackermann (19990225-T959)"
date: "2025-11-18"
output:
  pdf_document: default
  html_document:
    fig_caption: true
---

```{r setup, include = FALSE}
# Set random seed for reproducibility using birthdate YYMMDD
set.seed(022599)
setwd("/Users/nicolasackermann/Projects/5BD000")
# Load required packages, no additional packages used beyond base R
```

```{r}
library(ggplot2)
library(grid)
```

```{r}
cases <- read.delim("cases-1.tsv", sep = "\t", header = TRUE)
population <- read.delim("population-1.tsv", sep = "\t", header = TRUE)

# Renaming because it is called n here and n_pop in the other file
names(cases)[names(cases) == "n"] <- "n_cases"

cases$year <- as.numeric(as.character(cases$year))
population$year <- as.numeric(as.character(population$year))

cases$agegroup <- factor(cases$agegroup, levels = unique(cases$agegroup))
population$agegroup <- factor(population$agegroup, levels = unique(population$agegroup))
```

---

# Task 1: Cases by Age Group and Sex
Showing the number of cases by age group and sex. Conclusion from the graph.

```{r}
# Sum of cases per age group and sex across all years
cases_agg_total <- aggregate(n_cases ~ agegroup + sex, data = cases, FUN = sum)

# Stacked bars
p1 <- ggplot(cases_agg_total, aes(x = agegroup, y = n_cases, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    title = "Stacked",
    x = "Age Group (Years)",
    y = "Number of Cases",
    fill = "Sex"
  ) +
  scale_fill_manual(values = c("Female" = "#E69F00", "Male" = "#56B4E9")) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Dodged bars
p1_alt <- ggplot(cases_agg_total, aes(x = agegroup, y = n_cases, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Side-by-side (Dodged)",
    x = "Age Group (Years)",
    y = "Number of Cases",
    fill = "Sex"
  ) +
  scale_fill_manual(values = c("Female" = "#E69F00", "Male" = "#56B4E9")) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Puting them next to each other
grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 2)))

print(p1,     vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
print(p1_alt, vp = viewport(layout.pos.row = 1, layout.pos.col = 2))
```

### Observations:

Age is the Dominant Factor:

The graph demonstrates an extremely strong positive correlation between age and the number of cases.

The number of cases begins to increase rapidly starting around the 45-49 age group.

The vast majority of cases occur in the elderly population, with the peak incidence observed in the 75-79 age group.

```{r}
p1_faceted <- ggplot(cases_agg_total, aes(x = agegroup, y = n_cases, fill = sex)) +
  geom_bar(stat = "identity") +
  # Separating the data into panels by sex
  facet_wrap(~sex, scales = "free_y", ncol = 2) +
  labs(
    title = "Colon Cancer Cases by Age Group, Separated by Sex (All Years Combined)",
    x = "Age Group (Years)",
    y = "Number of Cases"
  ) +
  scale_fill_manual(values = c("Female" = "#E69F00", "Male" = "#56B4E9")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none", # Legend is not needed since panels are labelled
    plot.title = element_text(hjust = 0.5)
  )

print(p1_faceted)
```

---

# Task 2: Total Cases Over Calendar Years
Total number of cases in each calendar year by males and females... 
Showing the number of cases over calendar years.

```{r}
# Sum of cases per year and sex
cases_yearly <- aggregate(n_cases ~ year + sex, data = cases, FUN = sum)

# Only showing every 5th year for cleaner x-axis labels (overlaps otherwise)
year_breaks <- seq(min(cases_yearly$year), max(cases_yearly$year), by = 5)

p2 <- ggplot(cases_yearly, aes(x = year, y = n_cases, color = sex)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    title = "Total Colon Cancer Cases Over Calendar Years by Sex",
    x = "Calendar Year",
    y = "Total Number of Cases",
    color = "Sex"
  ) +
  scale_color_manual(values = c("Female" = "#E69F00", "Male" = "#56B4E9")) +
  scale_x_continuous(
    breaks = year_breaks,
    labels = as.character(year_breaks)
  ) +
  theme_minimal()

print(p2)
```

## Observations: 

Clear Upward Trend:

There is a consistent and substantial upward trend in the total number of colon cancer cases for both males and females.

Sex-Specific Patterns:
In most years throughout the period, the total number of cases is slightly higher for females (orange) than for males (blue).

In the most recent years (around 2015 to 2022), the case counts for males and females seem to converge (especially in comparison to the 1980 to 1990 period), indicating a more equal distribution between the sexes.

---

# Task 3: Population Size by Age, Year, and Sex
Graphs that illustrate the population size over age groups and calendar year simultaneously, separately by males and females.

```{r, fig.width = 10, fig.height = 8}
year_breaks_pop <- seq(min(population$year), max(population$year), by = 5)

# Line plot faceted by sex
p3 <- ggplot(population, aes(x = year, y = n_pop, color = agegroup, group = agegroup)) +
  geom_line(linewidth = 0.8) +
  facet_wrap(~sex, scales = "free_y", ncol = 1) + # Separate panels for Male and Female
  labs(
    title = "Population Size (Persons at Risk) Over Calendar Years by Age Group and Sex",
    x = "Calendar Year",
    y = "Population Size (n_pop)",
    color = "Age Group"
  ) +
  scale_x_continuous(
    breaks = year_breaks_pop,             # Using breaks every 5 years
    labels = as.character(year_breaks_pop)
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels
  # --------------------------
  theme_minimal() +
  theme(
    legend.position = "bottom", # Moving legend for better layout
    plot.title = element_text(hjust = 0.5) # Centering the title
  )

print(p3)
```

---

# Task 4: Merging and Total Cases/Population
Merging the information... Does the population file include the same age groups and calendar years... Also creating a separate data frame with the total number of cases and the total population size...

```{r}
# --- Question 4a: Merging Data Frames ---
merged_data <- merge(cases, population, by = c("agegroup", "year", "sex"), all = TRUE)

# --- Question 4b: Checking for consistent age groups and years ---
check_merge <- merged_data[is.na(merged_data$n_cases) | is.na(merged_data$n_pop), ]

cat("\n--- Data Alignment Check ---\n")
if (nrow(check_merge) == 0) {
  cat("The 'cases' and 'population' files include the same combinations of age groups, years, and sex.\n")
} else {
  cat("The 'cases' and 'population' files do NOT include the same combinations. Missing values found:\n")
  cat("Number of combinations with missing data:", nrow(check_merge), "\n")
  print(check_merge)
}
cat("---\n\n")

# --- Question 4c: Creating Data Frame with Totals ---
# Removing rows with NA before accurate summation (if alignment check failed)
complete_merged_data <- merged_data[!is.na(merged_data$n_cases) & !is.na(merged_data$n_pop), ]

# Aggregating total cases and total population per year and sex
totals_yearly <- aggregate(
  cbind(total_cases = n_cases, total_population = n_pop) ~ year + sex,
  data = complete_merged_data,
  FUN = sum
)

# Printing the resulting data frame
cat("--- Data Frame with Yearly Totals ---\n")
print(totals_yearly)
cat("---\n")
```

---

# Task 5: Calculating Incidence Rates
Calculating the incidence rate in two ways:

Age-Specific Incidence Rate (ASIR): Using the complete merged data (merged_data).

Crude Incidence Rate (CIR): Using the aggregated yearly totals (totals_yearly).

### Incidence rate: definition and comments

In epidemiology, an **incidence rate** describes how frequently new cases of a disease occur in a population over a given time period. In continuous time, it is usually defined as

\[
IR = \frac{\text{number of new cases during the period}}{\text{total person\text{-}time at risk during the period}}.
\]

In this assignment, we approximate the incidence rate by dividing the number of new colon cancer cases by the population size:

\[
IR_{a,s,t} = \frac{ \text{cases}_{a,s,t} }{ \text{population}_{a,s,t} } \times 100{,}000,
\]

where \(a\) denotes age group, \(s\) sex, and \(t\) calendar year. When we sum over all age groups we obtain the **crude incidence rate**

\[
CIR_{s,t} = \frac{ \sum_a \text{cases}_{a,s,t} }{ \sum_a \text{population}_{a,s,t} } \times 100{,}000.
\]

This method ignores the exact personâ€“time at risk and treats the yearly population size as if everyone contributes one year of follow-up. Strictly speaking, it therefore estimates an incidence **proportion** rather than a true incidence rate. However, with large populations and annual data this is a common and reasonable approximation, as long as the population size does not change dramatically within each year. A limitation is that the crude rate does not adjust for changes in the age distribution over time, which is why the age-specific rates are also important to inspect.

```{r}
# --- Version 1. Age-Specific Incidence Rate (ASIR) ---
merged_data$incidence_rate_asir <- merged_data$n_cases / merged_data$n_pop

# --- Version 2. Crude Incidence Rate (CIR) ---
totals_yearly$incidence_rate_cir <- totals_yearly$total_cases / totals_yearly$total_population

# Inspecting the new data frames (optional)
cat("--- Sample of Data with Age-Specific Incidence Rate ---\n")
print(head(merged_data[, c("agegroup", "year", "sex", "n_cases", "n_pop", "incidence_rate_asir")]))
cat("\n--- Data with Crude Incidence Rate ---\n")
print(totals_yearly)
```

---

# Task 6: Plotting Crude Incidence Rate Over Time
Focusing on plotting the Crude Incidence Rate (CIR) over time and applying a smoother (a trend line).

```{r}
# Showing every 5th year for cleaner x-axis labels
year_breaks_cir <- seq(min(totals_yearly$year), max(totals_yearly$year), by = 5)

# Convert rate to 'per 100,000' for better readbility
totals_yearly$cir_per_100k <- totals_yearly$incidence_rate_cir * 100000

p6 <- ggplot(totals_yearly, aes(x = year, y = cir_per_100k, color = sex)) +
  geom_line(linewidth = 1) +
  geom_point() +
  # Apply a smoother (e.g., LOESS or linear model 'lm')
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed", linewidth = 0.8) +
  labs(
    title = "Crude Incidence Rate (CIR) of Colon Cancer Over Time (per 100,000)",
    x = "Calendar Year",
    y = "Crude Incidence Rate (per 100,000 persons)",
    color = "Sex"
  ) +
  scale_color_manual(values = c("Female" = "#E69F00", "Male" = "#56B4E9")) +
  scale_x_continuous(breaks = year_breaks_cir) +
  theme_minimal()

print(p6)
```

The smoothed trend lines indicate that the increase is not linear:

There is a steeper rise during the 1970s and early 1980s. A plateau or slower growth appears around the late 1980s to mid-1990s. After the 2000s, the incidence begins to increase again for both sexes.

---
