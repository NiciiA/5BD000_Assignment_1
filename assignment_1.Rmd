---
title: "5BD000 Assignment 1"
author: "Nicolas Ackermann (19990225-T959), Andri Þór Stefánsson (19990320-1698),"
date: "2025-11-18"
output:
  pdf_document: default
---

```{r setup, include = FALSE}
# Set random seed for reproducibility using birthdate YYMMDD
set.seed(022599)
# Load required packages, no additional packages used beyond base R
```

```{r}
library(ggplot2)
library(grid)
```

```{r}
cases <- read.delim("cases-1.tsv", sep = "\t", header = TRUE)

# Renaming because it is called n here and n_pop in the other file
names(cases)[names(cases) == "n"] <- "n_cases"

cases$year <- as.numeric(as.character(cases$year))

cases$agegroup <- factor(cases$agegroup, levels = unique(cases$agegroup))
```

---

# Task 1: Cases by Age Group and Sex
Showing the number of cases by age group and sex. Conclusion from the graph.

```{r echo=FALSE}
# Sum of cases per age group and sex across all years
cases_agg_total <- aggregate(n_cases ~ agegroup + sex, data = cases, FUN = sum)

# Dodged bars
p1 <- ggplot(cases_agg_total, aes(x = agegroup, y = n_cases, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Number of Colon Cancer Cases by Age Group and Sex",
    x = "Age Group (Years)",
    y = "Number of Cases",
    fill = "Sex"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


print(p1)
```

### Observations:

Age is the Dominant Factor:

The graph demonstrates an extremely strong positive correlation between age and the number of cases.

The number of cases begins to increase rapidly starting around the 45-49 age group.

The vast majority of cases occur in the elderly population, with the peak incidence observed in the 75-79 age group.


---

# Task 2: Total Cases Over Calendar Years
Total number of cases in each calendar year by males and females... 
Showing the number of cases over calendar years.

```{r}
# Sum of cases per year and sex
cases_yearly <- aggregate(n_cases ~ year + sex, data = cases, FUN = sum)
```


```{r echo=FALSE}
# Only showing every 5th year for cleaner x-axis labels (overlaps otherwise)
year_breaks <- seq(min(cases_yearly$year), max(cases_yearly$year), by = 5)

p2 <- ggplot(cases_yearly, aes(x = year, y = n_cases, color = sex)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    title = "Total Colon Cancer Cases Over Calendar Years by Sex",
    x = "Calendar Year",
    y = "Total Number of Cases",
    color = "Sex"
  ) +
  scale_x_continuous(
    breaks = year_breaks,
    labels = as.character(year_breaks)
  ) +
  theme_minimal()

print(p2)
```

## Observations: 

Clear Upward Trend:

There is a consistent and substantial upward trend in the total number of colon cancer cases for both males and females.

Sex-Specific Patterns:
In most years throughout the period, the total number of cases is slightly higher for females (orange) than for males (blue).

In the most recent years (around 2015 to 2022), the case counts for males and females seem to converge (especially in comparison to the 1980 to 1990 period), indicating a more equal distribution between the sexes.

---

# Task 3: Population Size by Age, Year, and Sex

```{r}
population <- read.delim("population-1.tsv", sep = "\t", header = TRUE)
population$year <- as.numeric(as.character(population$year))
population$agegroup <- factor(population$agegroup, levels = unique(population$agegroup))
```


Graphs that illustrate the population size over age groups and calendar year simultaneously, separately by males and females.



```{r, fig.width = 10, fig.height = 8 echo=FALSE}
# Line plot faceted by sex
year_breaks_pop <- seq(min(population$year), max(population$year), by = 5)

p3 <- ggplot(population, aes(x = year, y = n_pop, color = agegroup, group = agegroup)) +
  geom_line(linewidth = 0.8) +
  facet_wrap(~sex, scales = "free_y", ncol = 1) + # Separate panels for Male and Female
  labs(
    title = "Population Size (Persons at Risk) Over Calendar Years by Age Group and Sex",
    x = "Calendar Year",
    y = "Population Size (n_pop)",
    color = "Age Group"
  ) +
  scale_x_continuous(
    breaks = year_breaks_pop,             # Using breaks every 5 years
    labels = as.character(year_breaks_pop)
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels
  # --------------------------
  theme_minimal() +
  theme(
    legend.position = "bottom", # Moving legend for better layout
    plot.title = element_text(hjust = 0.5) # Centering the title
  )

print(p3)
```

```{r}
p31 <- ggplot(population, aes(x = year, y = agegroup, fill = n_pop)) +
  geom_tile(color = "white") +                   
  scale_fill_gradient(low = "yellow", high = "red") +
  facet_wrap(~sex) +                             
  labs(
    x = "Year",
    y = "Age group",
    fill = "Population size",
    title = "Population size over age groups and years by sex"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    strip.text = element_text(face = "bold")          
  )

print(p31)
```


---

# Task 4: Merging and Total Cases/Population
Merging the information... Does the population file include the same age groups and calendar years... Also creating a separate data frame with the total number of cases and the total population size...

```{r}
# --- Question 4a: Merging Data Frames ---
merged_data <- merge(cases, population, by = c("agegroup", "year", "sex"), all = TRUE)

# --- Question 4b: Checking for consistent age groups and years ---
check_merge <- merged_data[is.na(merged_data$n_cases) | is.na(merged_data$n_pop), ]

cat("\n--- Data Alignment Check ---\n")
if (nrow(check_merge) == 0) {
  cat("The 'cases' and 'population' files include the same combinations of age groups, years, and sex.\n")
} else {
  cat("The 'cases' and 'population' files do NOT include the same combinations. Missing values found:\n")
  cat("Number of combinations with missing data:", nrow(check_merge), "\n")
  print(check_merge)
}
cat("---\n\n")

# --- Question 4c: Creating Data Frame with Totals ---
# Removing rows with NA before accurate summation (if alignment check failed)
complete_merged_data <- merged_data[!is.na(merged_data$n_cases) & !is.na(merged_data$n_pop), ]

# Aggregating total cases and total population per year and sex
totals_yearly <- aggregate(
  cbind(total_cases = n_cases, total_population = n_pop) ~ year + sex,
  data = complete_merged_data,
  FUN = sum
)

# Printing the resulting data frame
cat("--- Data Frame with Yearly Totals ---\n")
print(totals_yearly)
cat("---\n")
```

---

# Task 5: Calculating Incidence Rates
Calculating the incidence rate in two ways:

Age-Specific Incidence Rate (ASIR): Using the complete merged data (merged_data).

Crude Incidence Rate (CIR): Using the aggregated yearly totals (totals_yearly).

### Incidence rate: definition and comments

In epidemiology, an **incidence rate** describes how frequently new cases of a disease occur in a population over a given time period. In continuous time, it is usually defined as

\[
IR = \frac{\text{number of new cases during the period}}{\text{total person\text{-}time at risk during the period}}.
\]

In this assignment, we approximate the incidence rate by dividing the number of new colon cancer cases by the population size:

\[
IR_{a,s,t} = \frac{ \text{cases}_{a,s,t} }{ \text{population}_{a,s,t} } \times 100{,}000,
\]

where \(a\) denotes age group, \(s\) sex, and \(t\) calendar year. When we sum over all age groups we obtain the **crude incidence rate**

\[
CIR_{s,t} = \frac{ \sum_a \text{cases}_{a,s,t} }{ \sum_a \text{population}_{a,s,t} } \times 100{,}000.
\]

This method ignores the exact person–time at risk and treats the yearly population size as if everyone contributes one year of follow-up. Strictly speaking, it therefore estimates an incidence **proportion** rather than a true incidence rate. However, with large populations and annual data this is a common and reasonable approximation, as long as the population size does not change dramatically within each year. A limitation is that the crude rate does not adjust for changes in the age distribution over time, which is why the age-specific rates are also important to inspect.

```{r}
# --- Version 1. Age-Specific Incidence Rate (ASIR) ---
merged_data$asir <- merged_data$n_cases / merged_data$n_pop

# --- Version 2. Crude Incidence Rate (CIR) ---
totals_yearly$cir <- totals_yearly$total_cases / totals_yearly$total_population

tail(merged_data)
```

---

# Task 6: Plotting Crude Incidence Rate Over Time
Focusing on plotting the Crude Incidence Rate (CIR) over time and applying a smoother (a trend line).

```{r}
# Showing every 5th year for cleaner x-axis labels
year_breaks_cir <- seq(min(totals_yearly$year), max(totals_yearly$year), by = 5)

# Convert rate to 'per 100,000' for better readbility
totals_yearly$cir_per_100k <- totals_yearly$incidence_rate_cir * 100000

p6 <- ggplot(totals_yearly, aes(x = year, y = cir_per_100k, color = sex)) +
  geom_point() +
  # Apply a smoother (e.g., LOESS or linear model 'lm')
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.8) +
  labs(
    title = "Crude Incidence Rate (CIR) of Colon Cancer Over Time (per 100,000)",
    x = "Calendar Year",
    y = "Crude Incidence Rate (per 100,000 persons)",
    color = "Sex"
  ) +
  scale_x_continuous(breaks = year_breaks_cir) +
  theme_minimal()

print(p6)
```

The smoothed trend lines indicate that the increase is not linear:

There is a steeper rise during the 1970s and early 1980s. A plateau or slower growth appears around the late 1980s to mid-1990s. After the 2000s, the incidence begins to increase again for both sexes.

## Task 7
```{r}
year_sex_totals <- merged_data %>%
  mutate(sex = factor(sex)) %>%
  group_by(year, sex) %>%
  summarise(
    total_cases = sum(n_cases),
    total_pop   = sum(n_pop),
    .groups = "drop"
  )

pois_model <- glm(
  total_cases ~ year + sex,
  offset = log(total_pop),
  family = poisson,
  data = year_sex_totals
)
summary(pois_model)
```

# 8.

```{r}
# Create a specific dataframe for the years 1970 and 2020
predicted_data <- data.frame(
  year = c(1970, 1970, 2020, 2020),
  sex = as.factor(c("Male", "Female", "Male", "Female")),
  total_pop = 100000
)

# Predict the rates
predicted_data$cir <- predict(pois_model, newdata = predicted_data, type = "response")

# Display the results
print(predicted_data)

cat("The 1970 male–female IR difference is",abs(predicted_data$cir[1]-predicted_data$cir[2]),"\n")
cat("The 2020 male–female IR difference is",abs(predicted_data$cir[3]-predicted_data$cir[4]))
```
# 9.

```{r}
# Prepare the data
df_plot <- df_merged %>%
  mutate(
    incidence_rate = (n / n_pop) * 100000)

# Create the Graph
ggplot(df_plot, aes(x = year, y = incidence_rate, color = agegroup, group = agegroup)) +
  geom_point(alpha = 0.3, size = 1) + 
  geom_smooth(method = "loess", se = FALSE, linewidth = 1) + 
  facet_wrap(~ sex) + 
  
  scale_y_log10() + 
  labs(
    title = "Colon Cancer Incidence Rates over Calendar Year",
    subtitle = "Stratified by Age Group and Sex (with Loess Smoothing)",
    x = "Calendar Year",
    y = "Incidence Rate (per 100,000) - Log Scale",
    color = "Age Group"
  ) +
  theme_minimal()
```

# 10.
```{r}
model_interaction <- glm(n ~ ns(year, df = 4)*sex + ns(year, df = 4)*agegroup,
                         offset = log(n_pop),
                         family = poisson(link = "log"),
                         data = df_merged)

target_data <- data.frame(
  year = c(1970, 1970, 2020, 2020),
  sex = as.factor(c("Male", "Female", "Male", "Female")),
  agegroup = "70-74", 
  n_pop = 100000
)

target_data$predicted_rate <- predict(model_interaction, 
                                    newdata = target_data,
                                    type = "response")
target_data
```

Here is a plot I made to try to explain why the rate is now higher for men than for women.
We see that the rate is higher in older age groups, and from earlier, when plotting the population, we saw that women reach older ages than men on average. that might be a part of the reason why the rate is higher for men in each age group.

```{r}
age_levels <- unique(df_merged$agegroup)

target_data <- expand.grid(
  year = seq(1970, 2020, by=1),
  sex = c("Male","Female"),
  agegroup = age_levels,
  n_pop = 100000
)


# Ensure proper factor levels
target_data$agegroup <- factor(target_data$agegroup, levels = age_levels)
target_data$sex <- factor(target_data$sex, levels = c("Male","Female"))

target_data$predicted_rate <- predict(model_interaction, 
                                    newdata = target_data,
                                    type = "response")

target_data <- target_data %>% group_by(agegroup, sex) %>% summarize(predicted_rate = mean(predicted_rate))

ggplot(target_data, aes(x = agegroup, y = predicted_rate, group = sex, color = sex)) +
  geom_line(size = 1.2) +
  labs(
    title = "Predicted Incidence Rates by Age Group averaged over all years",
    x = "Age Group",
    y = "Predicted Incidence Rate per 100,000",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```


# 11.


```{r}
df_q11 <- df_merged %>%
  mutate(
    lower_bound = as.numeric(str_extract(agegroup, "^[0-9]+")),
    age_mid = lower_bound + 2
  )
model_spline_age <- glm(n ~ ns(year, df = 4) * ns(age_mid, df = 4) * sex + offset(log(n_pop)),
                        family = poisson(link = "log"),
                        data = df_q11)

# --- A. Predict data (Lines) ---
# at 52, 72, 87 year-old
pred_data <- expand.grid(
  year = 1970:2020,
  sex = df_q11$sex,
  age_mid = c(52, 72, 87),
  n_pop = 100000
)

pred_data$fitted_rate <- predict(model_spline_age, newdata = pred_data, type = "response")

# --- B. observation data (Points) ---
obs_data <- df_q11 %>%
  filter(agegroup %in% c("50-54", "70-74", "85-89")) %>%
  mutate(
    obs_rate = (n / n_pop) * 100000,
    target_age = case_when(
      agegroup == "50-54" ~ 52,
      agegroup == "70-74" ~ 72,
      agegroup == "85-89" ~ 87 
    )
  )

ggplot() +
  geom_point(data = obs_data, 
             aes(x = year, y = obs_rate, color = sex), 
             alpha = 0.4, shape = 1) +
  
  geom_line(data = pred_data, 
            aes(x = year, y = fitted_rate, color = sex), 
            linewidth = 1) +
  facet_wrap(~ age_mid, scales = "free_y", labeller = label_both, ncol=1) +
  labs(
    title = "Colon Cancer Incidence: Model vs Observed",
    subtitle = "Lines = Spline Model Predictions (Ages 52, 72, 87)\nPoints = Observed Crude Rates (Groups 50-54, 70-74, 85-89)",
    y = "Incidence Rate (per 100,000)",
    x = "Year",
    color = "Sex"
  ) +
  theme_minimal()
```

# 12.
```{r}

# --- Step 1: Define the Standard Population (2022) ---
std_pop_2022 <- df_q11 %>%
  filter(year == 2022) %>%
  select(sex, age_mid, std_pop = n_pop)

# --- Step 2: Calculate Observed Age-Specific Rates---
df_observed_rates <- df_q11 %>%
  mutate(obs_rate_per_person = n / n_pop)

# --- Step 3: Calculate Age-Standardized Rates (ASR) ---
# Formula: Sum(Observed_Rate_age_i * Pop_std_age_i) / Total_std_pop
df_standardized <- df_observed_rates %>%
  left_join(std_pop_2022, by = c("sex", "age_mid")) %>%
  group_by(year, sex) %>%
  summarise(
    expected_cases = sum(obs_rate_per_person * std_pop),
    total_std_pop = sum(std_pop),
    .groups = "drop"
  ) %>%
  mutate(
    rate = (expected_cases / total_std_pop) * 100000,
    type = "Age-Standardized (Observed)" 
  ) %>%
  select(year, sex, rate, type)

# --- Step 4: Calculate Crude Rates (for Comparison) ---
df_crude <- df_q11 %>%
  group_by(year, sex) %>%
  summarise(
    total_cases = sum(n),
    total_pop = sum(n_pop),
    .groups = "drop"
  ) %>%
  mutate(
    rate = (total_cases / total_pop) * 100000,
    type = "Crude (Non-standardized)"
  ) %>%
  select(year, sex, rate, type)

# --- Step 5: Combine and Plot ---
df_final_plot <- bind_rows(df_standardized, df_crude)

# Create the comparison graph
ggplot(df_final_plot, aes(x = year, y = rate, color = sex, linetype = type)) +
  geom_line(linewidth = 1.2) +
  labs(
    title = "Crude vs. Direct Age-Standardized Incidence Rates",
    subtitle = "Based on OBSERVED Data (Standardized to 2022 Population)",
    y = "Incidence Rate (per 100,000 person-years)",
    x = "Calendar Year",
    color = "Sex",
    linetype = "Rate Type"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# 13.
```{r}
# ==============================================================================
# Step 1: Define the Standard Population Weights (Year 2022)
std_pop_weights <- df_q11 %>%
  filter(year == 2022) %>%
  select(sex, age_mid, std_weight = n_pop)

# ==============================================================================
# Step 2: Method A - Direct Standardization of OBSERVED Rates (from Q12)
df_asr_observed <- df_q11 %>%
  mutate(raw_rate = n / n_pop) %>%
  left_join(std_pop_weights, by = c("sex", "age_mid")) %>%
  group_by(year, sex) %>%
  summarise(
    weighted_sum = sum(raw_rate * std_weight),
    total_weight = sum(std_weight),
    .groups = "drop"
  ) %>%
  mutate(
    rate = (weighted_sum / total_weight) * 100000,
    method = "Observed (Direct)" # Label for the plot
  )

# Step 3: Method B - Standardization of MODEL PREDICTED Rates (The Q13 Task)

pred_grid <- expand.grid(
  year = 1970:2022,
  age_mid = unique(df_q11$age_mid),
  sex = unique(df_q11$sex),
  n_pop = 100000 # Arbitrary population base to calculate the rate
)
pred_grid$pred_count <- predict(model_spline_age, newdata = pred_grid, type = "response")
pred_grid$pred_rate_per_person <- pred_grid$pred_count / 100000
df_asr_model <- pred_grid %>%
  left_join(std_pop_weights, by = c("sex", "age_mid")) %>%
  group_by(year, sex) %>%
  summarise(
    weighted_sum = sum(pred_rate_per_person * std_weight),
    total_weight = sum(std_weight),
    .groups = "drop"
  ) %>%
  mutate(
    rate = (weighted_sum / total_weight) * 100000,
    method = "Model-Based (Predicted)" 
  )

# Step 4: Combine and Plot the Comparison
df_comparison <- bind_rows(df_asr_observed, df_asr_model)
ggplot(df_comparison, aes(x = year, y = rate, color = sex, linetype = method)) +
  geom_line(aes(linewidth = method)) + 
  scale_linewidth_manual(values = c("Observed (Direct)" = 0.8, "Model-Based (Predicted)" = 1.2)) +
  
  labs(
    title = "Comparison of Age-Standardized Rates",
    subtitle = "Direct Standardization (Observed) vs. Model-Based Standardization (Predicted)\nStandardized to Sweden 2022 Population",
    y = "Incidence Rate (per 100,000 person-years)",
    x = "Calendar Year",
    color = "Sex",
    linetype = "Method",
    linewidth = "Method"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

