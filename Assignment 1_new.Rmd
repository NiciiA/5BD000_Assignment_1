---
title: "Bios-Assignment 1"
author: "Keyan Li"
date: "`r Sys.Date()`"
output: html_document
---

# Task 7
```{r}
library(tidyverse)
library(splines)
df_cases <- read_tsv("cases-1.tsv")
df_pop   <- read_tsv("population-1.tsv")
```



```{r}
df_merged <- inner_join(df_cases, df_pop, by = c("year", "sex", "agegroup"))

# --- (Aggregation) ---
df_model_data <- df_merged %>%
  group_by(year, sex) %>%
  summarise(
    total_cases = sum(n, na.rm = TRUE),       
    total_pop   = sum(n_pop, na.rm = TRUE),  
    .groups = "drop"
  ) %>%
  mutate(sex = as.factor(sex)) 

# --- Poisson Regression ---
model_smooth <- glm(total_cases ~ ns(year, df = 4) + sex + offset(log(total_pop)),
                    family = poisson(link = "log"),
                    data = df_model_data)


summary(model_smooth)

# --- Visualization (Generate smooth curves) ---

# 1. Create a prediction dataset
# We create a new data frame and fix the total pop at 100,000
# The result predicted in this way is directly "the incidence rate per 100,000 people".
pred_data <- df_model_data %>%
  select(year, sex) %>%
  mutate(total_pop = 100000)

# 2. Calculate the predicted value (Predicted Rates)
pred_data$fitted_rate <- predict(model_smooth, newdata = pred_data, type = "response")

# 3. Calculate the crude incidence rate of the original data(Crude Rates) For comparison
df_model_data <- df_model_data %>%
  mutate(crude_rate = (total_cases / total_pop) * 100000)

df_model_data$sex <- as.factor(df_model_data$sex)
pred_data$sex     <- as.factor(pred_data$sex)

# plot
ggplot() +
  geom_point(data = df_model_data, 
             aes(x = year, y = crude_rate, color = sex), 
             alpha = 0.5) +
  geom_line(data = pred_data, 
            aes(x = year, y = fitted_rate, color = sex), 
            linewidth = 1.2) +
  scale_color_manual(values = c("Male" = "#1f77b4", "Female" = "#d62728"),
                     ) +
  labs(
    title = "Smoothed Incidence Rate of Colon Cancer in Sweden",
    subtitle = "Poisson Regression using Natural Splines (df=4)",
    y = "Incidence Rate (per 100,000 person-years)",
    x = "Calendar Year",
    color = "Sex"
  ) +
  theme_minimal()
```



# Task 8
```{r}
# Create a specific dataframe for the years 1970 and 2020
target_data <- data.frame(
  year = c(1970, 1970, 2020, 2020),
  sex = as.factor(c("Male", "Female", "Male", "Female")), #
  total_pop = 100000
)

# Predict the rates
target_data$predicted_rate <- predict(model_smooth, newdata = target_data, type = "response")

# Display the results
print(target_data)
```

Incidence Rates in 1970: Based on the model output, the estimated incidence rates in 1970 (per 100,000 person-years) are: 

Males: 26.2

Females: 27.7

Incidence Rates in 2020: Based on the model output, the estimated incidence rates in 2020 (per 100,000 person-years) are:

Males: 48.4

Females: 51.2

Model Assumptions:

Regarding changes over calendar years: The model uses a natural spline function with 4 degrees of freedom. This assumes that the trend of incidence rates over time is non-linear and smooth. It allows the rate to curve (increase or decrease at varying speeds) rather than forcing it to follow a strict straight line, but it assumes there are no sudden, jagged jumps in the rate.

Regarding the difference between males and females: The model includes sex as a main effect. This assumes that the difference between males and females is constant on the log scale (proportional hazards). In other words, it assumes the "shape" of the trend over time is identical for both sexes (parallel curves), and the ratio of female-to-male incidence remains the same throughout the entire period (1970â€“2020).

# Task 9

```{r}
library(ggplot2)
library(dplyr)

# Prepare the data
df_plot <- df_merged %>%
  mutate(incidence_rate = (n / n_pop) * 100000)

# Create the Graph
ggplot(df_plot, aes(x = year, y = incidence_rate, color = agegroup, group = agegroup)) +
  geom_point(alpha = 0.3, size = 1) + 
  geom_smooth(method = "loess", se = FALSE, linewidth = 1) + 
  facet_wrap(~ sex) + 
  
  scale_y_log10() + 
  labs(
    title = "Colon Cancer Incidence Rates over Calendar Year",
    subtitle = "Stratified by Age Group and Sex (with Loess Smoothing)",
    x = "Calendar Year",
    y = "Incidence Rate (per 100,000) - Log Scale",
    color = "Age Group"
  ) +
  theme_minimal()
```

Conclusions:

Strong Age Effect: The graph clearly shows that incidence rates increase exponentially with age, indicated by the distinct vertical separation of the age-group lines on the log scale. Age is the strongest predictor of risk.

Time Trend: There is a general upward trend in incidence rates from 1970 to 2020 across most adult age groups, indicating a period effect where risk has increased over time.

Sex Difference: Males consistently show slightly higher incidence rates than females of the same age, though the temporal trends (slope of the lines) are similar between sexes.

Non-linearity: The smoothed lines show some curvature, justifying the use of splines rather than a strict linear assumption for the calendar year effect.



# Task 10

```{r}
library(splines)
library(dplyr)

# --- Fit the Interaction Model ---
model_interaction <- glm(n ~ ns(year, df = 4) * sex + ns(year, df = 4) * agegroup + offset(log(n_pop)),
                         family = poisson(link = "log"),
                         data = df_merged,
                         control = list(maxit = 2000))

# --- Create a Prediction Dataset ---
target_data <- data.frame(
  year = c(1970, 1970, 2020, 2020),
  sex = as.factor(c("Male", "Female", "Male", "Female")),
  agegroup = "70-74", 
  n_pop = 100000
)

# --- Calculate the Predicted Rates ---
target_data$predicted_rate <- predict(model_interaction, newdata = target_data, type = "response")

# --- View the Answer ---
print(target_data)
```


# Task 11
```{r}
library(dplyr)
library(stringr)
library(splines)

df_q11 <- df_merged %>%
  mutate(
    lower_bound = as.numeric(str_extract(agegroup, "^[0-9]+")),
    age_mid = lower_bound + 2
  )
```

```{r}
# ns(year, 4) * ns(age_mid, 4) * sex 
model_spline_age <- glm(n ~ ns(year, df = 4) * ns(age_mid, df = 4) * sex + offset(log(n_pop)),
                        family = poisson(link = "log"),
                        data = df_q11)

```

```{r}
# --- A. Predict data (Lines) ---
# at 52, 72, 87 year-old
pred_data <- expand.grid(
  year = 1970:2020,
  sex = unique(df_q11$sex),
  age_mid = c(52, 72, 87),
  n_pop = 100000
)

pred_data$fitted_rate <- predict(model_spline_age, newdata = pred_data, type = "response")

# --- B. observation data (Points) ---
obs_data <- df_q11 %>%
  filter(agegroup %in% c("50-54", "70-74", "85-89")) %>%
  mutate(
    obs_rate = (n / n_pop) * 100000,
    target_age = case_when(
      agegroup == "50-54" ~ 52,
      agegroup == "70-74" ~ 72,
      agegroup == "85-89" ~ 87 
    )
  )
```

```{r}
library(ggplot2)

ggplot() +
  geom_point(data = obs_data, 
             aes(x = year, y = obs_rate, color = sex), 
             alpha = 0.4, shape = 1) +
  
  geom_line(data = pred_data, 
            aes(x = year, y = fitted_rate, color = sex), 
            linewidth = 1) +
  facet_wrap(~ age_mid, scales = "free_y", labeller = label_both) +
  labs(
    title = "Colon Cancer Incidence: Model vs Observed",
    subtitle = "Lines = Spline Model Predictions (Ages 52, 72, 87)\nPoints = Observed Crude Rates (Groups 50-54, 70-74, 85-89)",
    y = "Incidence Rate (per 100,000)",
    x = "Year",
    color = "Sex"
  ) +
  theme_minimal()
```


# Task 12

```{r}
library(dplyr)
library(ggplot2)

# --- Step 1: Define the Standard Population (2022) ---
std_pop_2022 <- df_q11 %>%
  filter(year == 2022) %>%
  select(sex, age_mid, std_pop = n_pop)

# --- Step 2: Prepare Prediction Data ---
pred_grid <- expand.grid(
  year = 1970:2022,              
  age_mid = unique(df_q11$age_mid),
  sex = unique(df_q11$sex),      
  n_pop = 100000    
)

# Predict the rate using the spline model from Q11 (model_spline_age)
pred_grid$pred_rate_per_person <- predict(model_spline_age, newdata = pred_grid, type = "response") / 100000

# --- Step 3: Calculate Age-Standardized Rates (ASR) ---
# Formula: Sum(Rate_age_i * Pop_std_age_i) / Total_std_pop
df_standardized <- pred_grid %>%
  left_join(std_pop_2022, by = c("sex", "age_mid")) %>%
  group_by(year, sex) %>%
  summarise(
    # Calculate the expected number of cases if the population was 2022's structure
    expected_cases = sum(pred_rate_per_person * std_pop),
    total_std_pop = sum(std_pop),
    .groups = "drop"
  ) %>%
  mutate(
    # Convert to rate per 100,000
    rate = (expected_cases / total_std_pop) * 100000,
    type = "Age-Standardized (2022 Pop)"
  ) %>%
  select(year, sex, rate, type)

# --- Step 4: Calculate Crude Rates (for Comparison) ---
# Recalculate the crude rate (Total Cases / Total Pop) for each year/sex
df_crude <- df_q11 %>%
  group_by(year, sex) %>%
  summarise(
    total_cases = sum(n),
    total_pop = sum(n_pop),
    .groups = "drop"
  ) %>%
  mutate(
    rate = (total_cases / total_pop) * 100000,
    type = "Crude (Non-standardized)"
  ) %>%
  select(year, sex, rate, type)

# --- Step 5: Combine and Plot ---
df_final_plot <- bind_rows(df_standardized, df_crude)

# Create the comparison graph
ggplot(df_final_plot, aes(x = year, y = rate, color = sex, linetype = type)) +
  geom_line(linewidth = 1.2) +
  scale_color_manual(values = c("Male" = "#1f77b4", "Female" = "#d62728")) +
  labs(
    title = "Comparison of Crude vs. Age-Standardized Incidence Rates",
    subtitle = "Standardized to the 2022 Swedish Population Structure",
    y = "Incidence Rate (per 100,000 person-years)",
    x = "Calendar Year",
    color = "Sex",
    linetype = "Rate Type"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```


# Task 13
```{r}
library(dplyr)
library(ggplot2)

# --- 1. Get the Weights (Standard Population: 2022) ---
std_pop_weights <- df_q11 %>%
  filter(year == 2022) %>%
  select(sex, age_mid, weight = n_pop)

# --- 2. Calculate Method A: Direct Standardization of OBSERVED Rates ---
df_asr_observed <- df_q11 %>%
  left_join(std_pop_weights, by = c("sex", "age_mid")) %>%
  mutate(raw_rate = n / n_pop) %>%
  group_by(year, sex) %>%
  summarise(
    weighted_sum = sum(raw_rate * weight),
    total_weight = sum(weight),
    .groups = "drop"
  ) %>%
  mutate(
    rate = (weighted_sum / total_weight) * 100000,
    method = "Observed (Empirical)"
  )

# --- 3. Calculate Method B: Standardization of MODEL PREDICTED Rates ---
pred_grid <- expand.grid(
  year = 1970:2022,
  age_mid = unique(df_q11$age_mid),
  sex = unique(df_q11$sex),
  n_pop = 100000
)

# Predict rates from the model
pred_grid$pred_rate_per_person <- predict(model_spline_age, newdata = pred_grid, type = "response") / 100000

df_asr_model <- pred_grid %>%
  left_join(std_pop_weights, by = c("sex", "age_mid")) %>%
  group_by(year, sex) %>%
  summarise(
    weighted_sum = sum(pred_rate_per_person * weight),
    total_weight = sum(weight),
    .groups = "drop"
  ) %>%
  mutate(
    rate = (weighted_sum / total_weight) * 100000,
    method = "Model-Based (Smoothed)"
  )

# --- 4. Combine and Plot Comparison ---
df_comparison <- bind_rows(df_asr_observed, df_asr_model)

ggplot(df_comparison, aes(x = year, y = rate, color = sex, linetype = method)) +
  geom_line(aes(linewidth = method)) + 
  scale_linewidth_manual(values = c("Observed (Empirical)" = 0.5, "Model-Based (Smoothed)" = 1.2)) +
  scale_color_manual(values = c("Male" = "#1f77b4", "Female" = "#d62728")) +
  labs(
    title = "Comparison of Age-Standardized Rates",
    subtitle = "Standardized to Sweden 2022 Population",
    y = "Incidence Rate (per 100,000)",
    x = "Calendar Year",
    color = "Sex",
    linetype = "Method",
    linewidth = "Method"
  ) +
  theme_minimal()
```












